(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["components/fa-poster/fa-poster"],{"0ede":function(t,e,n){},"245f":function(t,e,n){"use strict";n.r(e);var i=n("7524"),r=n.n(i);for(var o in i)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(o);e["default"]=r.a},4312:function(t,e,n){"use strict";n.d(e,"b",(function(){return r})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){return i}));var i={uPopup:function(){return n.e("uview-ui/components/u-popup/u-popup").then(n.bind(null,"f35f"))}},r=function(){var t=this.$createElement;this._self._c},o=[]},"5bb3":function(t,e,n){"use strict";n.r(e);var i=n("4312"),r=n("245f");for(var o in r)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return r[t]}))}(o);n("e686");var u=n("f0c5"),a=Object(u["a"])(r["default"],i["b"],i["c"],!1,null,"05abf9e2",null,!1,i["a"],void 0);e["default"]=a.exports},7524:function(t,e,n){"use strict";(function(t,i){var r=n("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=r(n("2eee")),u=r(n("278c")),a=r(n("c973"));function s(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,u=!0,a=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return u=t.done,t},e:function(t){a=!0,o=t},f:function(){try{u||null==n.return||n.return()}finally{if(a)throw o}}}}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var c=!1,f={name:"fa-poster",props:{value:{type:Boolean,default:!1},info:{type:Object,default:function(){return{}}}},watch:{value:function(t,e){t&&this.initCanvas()}},data:function(){return{width:750,height:1334,imgWidth:0,imgHeight:0,multiple:1,showCanvas:!1,posterImgs:""}},methods:{hide:function(){this.$emit("input",!1)},getWxCode:function(){var t=this;return new Promise((function(e,n){t.$api.getWxCode({id:t.info.id}).then((function(t){var i=t.code,r=t.data,o=t.msg;i?e(r):n(o)}))}))},downloadImg:function(e){return new Promise((function(n,i){t.downloadFile({url:e,success:function(t){200===t.statusCode?n(t.tempFilePath):i("图片下载失败")},fail:function(t){i(t)}})}))},getImageInfo:function(e){return new Promise((function(n,i){t.getImageInfo({src:e,success:function(t){n(t)},fail:function(t){i(t)}})}))},drawtext:function(t,e){for(var n=t.split(""),i=n.length,r=0,o=0,u=[],a=0,s=21*this.multiple,l=10.5*this.multiple,c=0;c<i;c++)/[\u4e00-\u9fa5]|[\uFE30-\uFFA0]/g.test(n[c])?a>0?o+s+a*l>e?(u.push({type:"text",content:t.substring(r,c)}),r=c,o=s,a=0):(o+=s+a*l,a=0):o+s>e?(u.push({type:"text",content:t.substring(r,c)}),r=c,o=s):o+=s:/\n/g.test(n[c])?(u.push({type:"break",content:t.substring(r,c)}),r=c+1,o=0,a=0):"\\"==n[c]&&"n"==n[c+1]?(u.push({type:"break",content:t.substring(r,c)}),r=c+2,o=0,a=0):/[a-zA-Z0-9]/g.test(n[c])?(a+=1,o+a*l>e&&(u.push({type:"text",content:t.substring(r,c+1-a)}),r=c+1-a,o=a*l,a=0)):o+l>e?(u.push({type:"text",content:t.substring(r,c)}),r=c,o=l):o+=l;return r<i&&u.push({type:"text",content:t.substring(r,i)}),u},initCanvas:function(){var t=this;return(0,a.default)(o.default.mark((function e(){var n,i,r,u;return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.downloadImg(t.info.image);case 2:return n=e.sent,e.next=5,t.getImageInfo(n);case 5:i=e.sent,r=i.width,u=i.height,r>u&&u>375?(t.width=2*u,t.height=2*u*1334/750,t.imgWidth=r):u>r&&r>375&&(t.width=2*r,t.height=2*r*1334/750,t.imgHeight=u),t.multiple=(t.width/750).toFixed(2),t.showCanvas=!0,t.$nextTick((function(){t.createPoster(n)}));case 13:case"end":return e.stop()}}),e)})))()},createPoster:function(e){var n=this;return(0,a.default)(o.default.mark((function i(){var r,a,l,c,f,h,d,p,m,g,w,v,b,y;return o.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:if(i.prev=0,!n.posterImgs){i.next=3;break}return i.abrupt("return");case 3:return t.showLoading({title:"海报生成中"}),r=t.createCanvasContext("poster",n),r.fillRect(0,0,n.width/2,n.height/2),r.setFillStyle("#FFF"),r.fillRect(0,0,n.width/2,n.height/2),n.drawImage(r,e),i.next=11,n.getWxCode();case 11:a=i.sent,l=17*n.multiple,c=n.drawtext(n.info.name,n.width/2-30*n.multiple),f=0,h=c.length,1==h?r.setFontSize(22*n.multiple):r.setFontSize(21*n.multiple),r.setFillStyle("#333"),d=s(c.entries());try{for(d.s();!(p=d.n()).done;)m=(0,u.default)(p.value,2),g=m[0],w=m[1],1==h?(f=n.width/2+50*(g+1)*n.multiple,r.fillText(w.content,l,f),f+=10):g<2&&(f=n.width/2+35*(g+1)*n.multiple,r.fillText(w.content,l,f))}catch(o){d.e(o)}finally{d.f()}return r.setFontSize(26*n.multiple),r.setFillStyle("#f00"),r.fillText("￥"+n.info.price,l,f+47*n.multiple),r.setFontSize(18*n.multiple),r.setFillStyle("#999"),v=(60+13*(n.info.price+"").length)*n.multiple,r.fillText("￥"+n.info.market_price,v,f+45*n.multiple),r.beginPath(),r.setLineWidth(1*n.multiple),r.moveTo(v-1,f+38*n.multiple),b=v+14*(n.info.market_price+"").length*n.multiple,r.lineTo(b,f+38*n.multiple),r.setStrokeStyle("#999"),r.stroke(),r.beginPath(),r.setLineWidth(1*n.multiple),r.moveTo(l,f+70*n.multiple),r.lineTo(n.width/2-20,f+70*n.multiple),r.setStrokeStyle("#eee"),r.stroke(),r.setFontSize(19*n.multiple),r.setFillStyle("#333"),r.fillText("长按识别二维码访问",l,f+110*n.multiple),r.setFontSize(16*n.multiple),r.setFillStyle("#999"),r.fillText(n.vuex_config.sitename||"",l,f+150*n.multiple),i.next=47,n.writefile(a);case 47:y=i.sent,r.drawImage(y,n.width/2-150*n.multiple,f+88*n.multiple,120*n.multiple,120*n.multiple),r.draw(!0,(function(){t.canvasToTempFilePath({canvasId:"poster",width:n.width/2,height:n.height/2,success:function(t){n.posterImgs=t.tempFilePath},fail:function(t){}},n),t.hideLoading()})),i.next=56;break;case 52:i.prev=52,i.t0=i["catch"](0),n.hide(),n.$u.toast(i.t0);case 56:case"end":return i.stop()}}),i,null,[[0,52]])})))()},writefile:function(t){return new Promise((function(e,n){var r=/data:image\/(\w+);base64,(.*)/.exec(t)||[],o=(0,u.default)(r,3),a=o[1],s=o[2];a||n(new Error("ERROR_BASE64SRC_PARSE"));var l=i.getFileSystemManager(),c="".concat(i.env.USER_DATA_PATH,"/").concat("tmp_base64src",".").concat(a),f=i.base64ToArrayBuffer(s);l.writeFile({filePath:c,data:f,encoding:"binary",success:function(){e(c)},fail:function(){n(new Error("ERROR_BASE64SRC_WRITE"))}})}))},drawImage:function(t,e){if(this.imgWidth){var n=(this.imgWidth-this.width/2)/2;t.drawImage(e,0,0,this.width/2+n,this.width/2,-n,0,this.width/2+n,this.width/2)}else if(this.imgHeight){var i=(this.imgHeight-this.width/2)/2+30;t.drawImage(e,0,0,this.width/2,this.width/2+i,0,-i,this.width/2,this.width/2+i)}else t.drawImage(e,0,0,this.width/2,this.width/2)},save:function(){var e=this;t.showLoading({title:"海报下载中"}),c?t.getSetting({success:function(n){n.authSetting["scope.writePhotosAlbum"]?t.saveImageToPhotosAlbum({filePath:e.posterImgs,success:function(){t.hideLoading(),t.showToast({title:"保存成功"})}}):t.showModal({title:"提示",content:"请先在设置页面打开“保存相册”使用权限",confirmText:"去设置",cancelText:"算了",success:function(e){e.confirm&&(t.hideLoading(),t.openSetting())}})}}):(c=!0,t.authorize({scope:"scope.writePhotosAlbum",success:function(){t.saveImageToPhotosAlbum({filePath:e.posterImgs,success:function(){t.hideLoading(),t.showToast({title:"保存成功"})}})}}))}}};e.default=f}).call(this,n("543d")["default"],n("bc2e")["default"])},e686:function(t,e,n){"use strict";var i=n("0ede"),r=n.n(i);r.a}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'components/fa-poster/fa-poster-create-component',
    {
        'components/fa-poster/fa-poster-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('543d')['createComponent'](__webpack_require__("5bb3"))
        })
    },
    [['components/fa-poster/fa-poster-create-component']]
]);
